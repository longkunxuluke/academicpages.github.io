---
title: 'Get the parameters of OPLS-AA force field and set up a MD simulation for LAMMPS'
date: 2020-11-13
permalink: /posts/2020/11/blog-post-4/
tags:
  - OPLS-AA
  - LAMMPS
  - MD simulation
---

Recently some people asked me how to get the parameters of OPLS-AA force field and set up a MD simulation for LAMMPS, here's a brief tutorial using an example of 10 ns NVT simulation of the system containing 1 solute (R) and 200 methanol solvent molecules. If you have other questions after reading the post, please let me know and I can add more details. 

### Step 1. Get the pdb files and associated parameters from LigPargen

First, making a pdb file of each molecule you want to add in the MD simulation, here in this tutorial is [R.pdb](https://github.com/longkunxuluke/ordered_solvent/blob/master/files/R.pdb) and [MeOH.pdb](https://github.com/longkunxuluke/ordered_solvent/blob/master/files/MeOH.pdb).

Go to [LigPargen server](http://zarbi.chem.yale.edu/ligpargen/), clicking "choose file", and read the above pdb file, then click "submit molecule", there would be many files for many different MD softwares available, download the GRO, TOP files of GROMACS and the LAMMPS file. If you get errors from LigPargen, you can try using mol files, or you can try SMILE code, for generating SMILE code, you can check this [page](http://www.cheminfo.org/flavor/malaria/Utilities/SMILES_generator___checker/index.html).

### Step 2. Change the formats of the parameters 

To use the parameters obtained from LigPargen server with fftool we will introduce below, we need to modify the formats of the parameters. [convertLigParGen.py](https://github.com/mccg-pas/group-wiki/tree/master/Scripts/ILMD) is a script written by [Michael Robinson](https://mccg.erc.monash.edu/group-members/) for this purpose. Following the information written by him, you can easily get the [R.ff](https://github.com/longkunxuluke/ordered_solvent/blob/master/files/R.ff) and [MeOH.ff](https://github.com/longkunxuluke/ordered_solvent/blob/master/files/MeOH.ff).

If you have ionic liquids in your system, just copying the coordinates and **il.ff** file from [here](https://github.com/agiliopadua/ilff).

### Step 3. Produce the input files using fftool

For the details about using fftool to generate LAMMPS input file and data file, you can check this [fftool](https://github.com/agiliopadua/fftool) page of Prof. Agilio Padua, which contains very detailed information. Make sure the atomic name in the .xyz or .zmat file used in this step are consistent with that in the .ff files, for example, if H atom is H00 in the .ff file, then you need to make sure it's also H00 in the .xyz or .zmat files. Also make sure the atomic names are different in each .ff and .xyz fiels, which means if we have a C01 atom in R.xyz and R.ff, there should be no C01 atom in the MeOH.xyz and MeOH.ff, you can change it to C001 for example. 

If you want to use the polarizable force field, you could also check the tutorial of the [pol_il](https://github.com/kateryna-goloviznina/pol_il) page. Note that the [packmol](http://m3g.iqm.unicamp.br/packmol/home.shtml) program will be used to get an initial system. If you want to know more details about using packmol, for example, if you want to place one type of molecules in a certain part of the simulation box, you can check this [tutorial](http://sobereva.com/473) written by Dr. Tian Lu. After this step, you should be able to get the [data.lmp](https://github.com/longkunxuluke/ordered_solvent/blob/master/files/data.lmp) and [in.lmp](https://github.com/longkunxuluke/ordered_solvent/blob/master/files/in.lmp). For simulations with polarizable force field, there are extra files needed, I will write more information if anyone is interested in this. Reading our [supporting information](https://pubs.acs.org/doi/abs/10.1021/jacs.0c05643) might be helpful. Generally speaking, if you want to use the Drude polarizable force field, or more specifically, the [CL&Pol](https://pubs.acs.org/doi/abs/10.1021/acs.jctc.9b00689) force field, you need the following parameters: atomic polarizability, dipole moment and the distance of dimers. 

### Step 4. Tweak the information of the in.lmp

Techniqually after Step 3, you should be able to submit the simulation. But speficically for my research, I usually need to add electric field information in, and I also need to write the information asscoiated with polarizable force field. I write a simple script to do this automatically, see [crin.py](https://github.com/longkunxuluke/ordered_solvent/blob/master/crin.py). To use it, you just need to ```python3 crin.py``` and provide your job name, the strength of the external electric field (along Z direction) and the job type. You need to put the four [template files](https://github.com/longkunxuluke/ordered_solvent/tree/master/files/template) into your local directory like **/scratch/x69/lx3539/file/** in my script. If you can help improve the script or/and add more functions into the script, I am very happy to hear your feedbacks.

### Some tips to deal with the LAMMPS errors

Two LAMMPS errors you most frequently meet might be **Errors: Out of range atoms - cannot compute PPPM** and **Error: Shake/bond atom missing**. Generally whenever you meet whatever errors from LAMMPS, you should ask google first as LAMMPS have an email list (I recommend you to join the email list and read the discussions feed everyday to learn) containing many useful discussions so you can solve most problems youself by using the suggestions people (usually the developers of LAMMPS) provide therein.

For error 1, you can try: (1) checking topology and force field parameters (2) using smaller simulation box (3) using **neigh_modify    every 1 delay 0 check yes** and using **neighbor        3.0 bin** (4) decreasing the timestep (5) re-building the system using a more reasonable volume, for example, the volume estimated using experimental density.

For error 2, you can try: (1) running an energy minimization before running MD simulation (2) sometimes reducing the number of cores is also useful (3) using a larger value for skin distance. 

